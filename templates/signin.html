<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8" />
    <title>登录 - 尹伟豪的官方网站</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link rel="shortcut icon" href="static/favicon.ico" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/uikit@3.11.1/dist/css/uikit.min.css" />
    <script src="https://cdn.jsdelivr.net/npm/uikit@3.11.1/dist/js/uikit.min.js"></script>
    <script src="https://cdn.jsdrilvr.net/npm/uikit@3.11.1/dist/js/uikit-icons.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/vue@3.2.45/dist/vue.global.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.3/dist/jquery.min.js"></script>
    <script src="/static/js/sha1.js"></script>
    <script>
        function validateEmail(email) {
            var re = /^[a-z0-9\.\-\_]+\@[a-z0-9\-\_]+(\.[a-z0-9\-\_]+){1,4}$/;
            return re.test(email.toLowerCase());
        }
        $(function () {
            var vm = new Vue({
                el: '#vm',
                data: {
                    email: '',
                    passwd: ''
                },
                methods: {
                    submit: function (event) {
                        event.preventDefault();
                        if (!this.email) {
                            document.getElementById('error').innerHTML = `<div class="uk-alert-danger uk-animation-slide-top" uk-alert>
                        <a class="uk-alert-close" uk-close></a>
                        <p>请输入邮箱</p>
                    </div>`;
                        return;
                        }
                        else if (!this.passwd) {
                            document.getElementById('error').innerHTML = `<div class="uk-alert-danger uk-animation-slide-top" uk-alert>
                        <a class="uk-alert-close" uk-close></a>
                        <p>请输入密码</p>
                    </div>`;
                        return;
                        }
                        else if (this.passwd.length < 6) {
                            document.getElementById('error').innerHTML = `<div class="uk-alert-danger uk-animation-slide-top" uk-alert>
                        <a class="uk-alert-close" uk-close></a>
                        <p>密码长度至少为6个字符</p>
                    </div>`;
                            return;
                        }
                        else if (!validateEmail(this.email.trim().toLowerCase())) {
                            document.getElementById('error').innerHTML = `<div class="uk-alert-danger uk-animation-slide-top" uk-alert>
                        <a class="uk-alert-close" uk-close></a>
                        <p>请输入正确的Email地址</p>
                    </div>`;
                            return;
                        }
                        
                
                        
                        
                        var email = this.email.trim().toLowerCase();
                        var that = this;
                        $.ajaxSettings.async = false;
                        $.getJSON('/api/users', function(r) {
                            
                        for (let x in r.users) {
                            if (email.trim().toLowerCase() === r.users[x].email) {
                                that.signin = true;
                                break;
                            }
                            
                        }
                    });
                        
                    $.ajaxSettings.async = true;
                    if (!this.signin) {
                                document.getElementById('error').innerHTML = `<div class="uk-alert-danger uk-animation-slide-top" uk-alert>
                            <a class="uk-alert-close" uk-close></a>
                            <p>暂无该用户</p>
                            </div>`;
                            return;
                    }
                    
                        $.post('api/authenticate', {
                                email: email,
                                passwd: this.passwd
                            },
                            function (r) {
                                location.assign('/');
                            });
                    }
                }
            });
        });
    </script>
</head>

<body class="uk-background-muted">
    <div uk-height-viewport class="uk-section uk-section-small uk-flex uk-flex-middle uk-text-center"
        style="min-height: calc((100vh - 80px) - 0px);">
        <div class="uk-width-1-1">
            <div class="uk-container" style="max-width: 330px;">
                <i style="font-size:50px; color: #444;">yinwwwhao</i>
                <p class="uk-text-lead">登录</p>
                <form id="vm" method="post" v-on:submit="submit">
                    <div class="uk-margin">
                        <div class="uk-inline uk-width-1-1">
                            <span class="uk-form-icon" uk-icon="icon: mail"></span>
                            <input v-model="email" class="uk-input" type="text" placeholder="电子邮箱" />
                        </div>
                    </div>
                    <div class="uk-margin">
                        <div class="uk-inline uk-width-1-1">
                            <span class="uk-form-icon" uk-icon="icon: lock"></span>
                            <input v-model="passwd" class="uk-input" type="password" placeholder="密码" />
                        </div>
                    </div>
                    <button class="uk-button uk-button-primary uk-width-1-1">登录</button>
                    <div id="error"></div>
                    <p class="uk-margin-medium-top"><a href="/">尹伟豪的官方网站</a></p>
                </form>
            </div>
        </div>

    </div>
    
</body>

</html>
